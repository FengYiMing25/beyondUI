
# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  # The Node.js orb contains a set of prepackaged CircleCI configuration you can utilize
  # Orbs reduce the amount of configuration required for common tasks.
  # See the orb documentation here: https://circleci.com/developer/orbs/orb/circleci/node
  node: circleci/node@4.1
jobs:
  prepare:
    docker: 
  -image: circleci/node:15.1
    steps:
      - checkout
      - restore_cache:
        key:
          - v2-dependencies-{{ checksum "package.json" }}
      - run: yarn install
      - save_cache: 
        paths:
        - node-modules
        key: v2-dependencies-{{ checksum "package.json" }}
      - persist_to_workspace:
        root: .
        paths:
        - node-modules
  build: 
    docker: 
    steps: 
    - checkout
    - attach_workspace:
      at: .
    run: yarn build
    - persist_to_workspace:
     root: .
      paths:
      - dist
  test:
      -image: circleci/node:15.1
    steps: 
    - checkout
    - attach_workspace:
      at: .
    run: yarn test

workflows:
version: 2.1
build_accept_deploy:
  jobs: 
    - prepare
    - build:
      requires:
      - test
    - test:
      requires:
      -prepare
